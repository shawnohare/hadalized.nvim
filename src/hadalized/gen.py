"""Render templates and write outputs."""

from pathlib import Path

from loguru import logger

from hadalized.cache import Cache
from hadalized.config import BuildDirective, Config
from hadalized.models import Template


def write_readme(target_dir: str | Path):
    path = Path(target_dir) / "README.md"
    if not path.exists():
        logger.info(f"Writing {path}")
        path.write_text("The files in this directory are autogenerated.")


class FileWriter:
    """Generate and write files containing hadalized palettes."""

    def __init__(self, config: Config | None = None):
        self.config: Config = config or Config()
        self.cache = Cache(self.config.cache_dir)
        self.build_dir: Path = self.config.build_dir

    def write_palettes(self, directive: BuildDirective) -> list[Path]:
        """Handler for when the build directive specifies that one file per
        palette should be generated."""
        if directive.context_type != "single":
            raise ValueError("Directive must have context_type == 'single'")
        template = Template(directive.template)
        written: list[Path] = []
        target_dir = self.config.build_dir / directive.subdir
        target_dir.mkdir(parents=True, exist_ok=True)

        for palette in self.config.palettes.values():
            path = target_dir / directive.file_name.format(palette=palette)
            context = palette.to(directive.extractor)
            ok, digest = self.cache.check(path, template, context)

            if ok:
                logger.info(f"Already generated {path}")
                continue

            logger.info(f"Writing {path}")
            template.write(path, context)
            self.cache.add(path, digest)
            written.append(path)
        return written

    def write_full(self, directive: BuildDirective) -> list[Path]:
        """Handle build directives with full context."""
        if directive.context_type != "full":
            raise ValueError("Directive must have context_type == 'full'")
        template = Template(directive.template)
        written: list[Path] = []
        target_dir = self.config.build_dir / directive.subdir
        target_dir.mkdir(parents=True, exist_ok=True)
        path = target_dir / directive.file_name
        context = self.config.to(directive.extractor)
        ok, digest = self.cache.check(path, template, context)
        if ok:
            logger.info(f"Already generated {path}")
        else:
            template.write(path, context)
            self.cache.add(path, digest)
            written.append(path)
        return written

    def write_all(self) -> list[Path]:
        """Generate all relevant files."""
        written = []
        for directive in self.config.directives.values():
            match directive.context_type:
                case "single":
                    written += self.write_palettes(directive)
                case "full":
                    written += self.write_full(directive)
        return written

    def __enter__(self):
        self.cache.connect()
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        self.cache.close()


def main():
    with FileWriter() as writer:
        writer = FileWriter()
        writer.write_all()


if __name__ == "__main__":
    main()
